<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Listing Lens ‚Äî New Scan</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=DM+Serif+Display&display=swap" rel="stylesheet">
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        :root {
            --bg: #FAFAF9; --bg-white: #FFFFFF; --text: #1A1A1A; --text-sec: #555; --text-muted: #888;
            --border: #E5E5E3; --border-light: #F0F0EE;
            --accent: #16803C; --accent-hover: #14662F; --accent-bg: #F0FDF4;
            --red: #DC2626; --red-bg: #FEF2F2;
            --radius: 10px;
            --font: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-display: 'DM Serif Display', Georgia, serif;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: var(--font); background: var(--bg); color: var(--text); line-height: 1.6; -webkit-font-smoothing: antialiased; }

        nav { background: rgba(250,250,249,0.92); backdrop-filter: blur(16px); border-bottom: 1px solid var(--border); padding: 0 24px; position: sticky; top: 0; z-index: 50; }
        .nav-inner { max-width: 800px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; height: 60px; }
        .logo { display: flex; align-items: center; gap: 10px; text-decoration: none; color: var(--text); }
        .logo-icon { width: 32px; height: 32px; background: var(--accent); border-radius: 8px; display: flex; align-items: center; justify-content: center; }
        .logo-icon svg { width: 18px; height: 18px; }
        .logo-text { font-weight: 700; font-size: 16px; }
        .nav-link { font-size: 14px; color: var(--text-muted); text-decoration: none; }
        .nav-link:hover { color: var(--text); }

        .container { max-width: 680px; margin: 0 auto; padding: 40px 24px 80px; }
        .page-title { font-family: var(--font-display); font-size: 28px; margin-bottom: 6px; }
        .page-sub { font-size: 15px; color: var(--text-sec); margin-bottom: 36px; }

        .step-section { margin-bottom: 32px; }
        .step-header { display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
        .step-badge { width: 28px; height: 28px; background: var(--accent); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 700; flex-shrink: 0; }
        .step-label { font-size: 16px; font-weight: 700; }

        .category-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        @media (max-width: 480px) { .category-grid { grid-template-columns: repeat(2, 1fr); } }
        .cat-btn { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; padding: 24px 12px; background: var(--bg-white); border: 2px solid var(--border); border-radius: var(--radius); cursor: pointer; transition: all 0.15s; font-family: var(--font); min-height: 100px; }
        .cat-btn:hover { border-color: var(--accent); background: var(--accent-bg); transform: translateY(-1px); box-shadow: 0 4px 12px rgba(22,128,60,0.08); }
        .cat-btn.selected { border-color: var(--accent); background: var(--accent-bg); box-shadow: 0 0 0 3px rgba(22,128,60,0.12); }
        .cat-btn .emoji { font-size: 32px; line-height: 1; }
        .cat-btn .label { font-size: 13px; font-weight: 700; text-align: center; color: var(--text); }
        .cat-btn .sublabel { font-size: 11px; color: var(--text-muted); text-align: center; line-height: 1.3; }

        .upload-zone { border: 2px dashed var(--border); border-radius: var(--radius); padding: 48px 24px; text-align: center; background: var(--bg-white); cursor: pointer; transition: all 0.15s; position: relative; }
        .upload-zone:hover, .upload-zone.dragover { border-color: var(--accent); background: var(--accent-bg); }
        .upload-zone svg { width: 40px; height: 40px; color: var(--text-muted); margin-bottom: 12px; }
        .upload-zone h3 { font-size: 16px; font-weight: 600; margin-bottom: 4px; }
        .upload-zone p { font-size: 14px; color: var(--text-muted); }
        .upload-zone input[type="file"] { position: absolute; inset: 0; opacity: 0; cursor: pointer; }
        .file-list { margin-top: 12px; display: flex; flex-direction: column; gap: 8px; }
        .file-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: var(--bg-white); border: 1px solid var(--border); border-radius: 8px; }
        .file-thumb { width: 48px; height: 48px; border-radius: 6px; object-fit: cover; border: 1px solid var(--border); }
        .file-info { flex: 1; min-width: 0; }
        .file-name { font-size: 14px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-size { font-size: 12px; color: var(--text-muted); }
        .file-remove { width: 28px; height: 28px; border: none; background: var(--red-bg); color: var(--red); border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }

        /* PAYMENT */
        .payment-section { display: none; }
        .payment-section.active { display: block; }
        .payment-box { background: var(--bg-white); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; }
        .payment-summary { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 16px; border-bottom: 1px solid var(--border-light); }
        .summary-label { font-size: 15px; color: var(--text-sec); }
        .summary-price { font-size: 24px; font-weight: 700; color: var(--accent); }
        .payment-loading { display: flex; align-items: center; gap: 12px; padding: 20px 0; color: var(--text-muted); font-size: 14px; }
        .payment-loading-spinner { width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; flex-shrink: 0; }
        #payment-element { margin-bottom: 20px; }
        .pay-btn { width: 100%; padding: 16px; font-family: var(--font); font-size: 16px; font-weight: 700; background: var(--accent); color: #fff; border: none; border-radius: var(--radius); cursor: pointer; transition: all 0.15s; }
        .pay-btn:hover:not(:disabled) { background: var(--accent-hover); transform: translateY(-1px); box-shadow: 0 4px 16px rgba(22,128,60,0.25); }
        .pay-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .payment-error { color: var(--red); font-size: 14px; margin-top: 12px; display: none; }
        .payment-secure { text-align: center; font-size: 13px; color: var(--text-muted); margin-top: 12px; display: flex; align-items: center; justify-content: center; gap: 6px; }
        .payment-secure svg { width: 14px; height: 14px; }

        /* PRICE PICKER */
        .price-picker { margin-bottom: 20px; }
        .price-picker-label { font-size: 13px; font-weight: 600; color: var(--text-muted); margin-bottom: 10px; letter-spacing: 0.03em; }
        .price-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .price-opt { position: relative; cursor: pointer; }
        .price-opt input[type="radio"] { position: absolute; opacity: 0; width: 0; height: 0; }
        .price-opt-inner { display: flex; flex-direction: column; align-items: center; padding: 14px 10px 12px; background: var(--bg); border: 2px solid var(--border); border-radius: var(--radius); transition: all 0.15s; text-align: center; }
        .price-opt:hover .price-opt-inner { border-color: var(--accent); }
        .price-opt input:checked + .price-opt-inner { border-color: var(--accent); background: var(--accent-bg); }
        .price-opt-amount { font-size: 22px; font-weight: 800; color: var(--text); line-height: 1; margin-bottom: 4px; }
        .price-opt input:checked + .price-opt-inner .price-opt-amount { color: var(--accent); }
        .price-opt-tag { font-size: 11px; font-weight: 600; color: var(--text-muted); }
        .price-opt input:checked + .price-opt-inner .price-opt-tag { color: var(--accent); }
        .price-opt-badge { display: inline-block; font-size: 10px; font-weight: 700; letter-spacing: 0.05em; background: var(--accent); color: #fff; border-radius: 4px; padding: 2px 6px; margin-bottom: 4px; }

        /* BETA */
        /* BETA */
        .beta-banner { background: var(--accent-bg); border: 1px solid rgba(22,128,60,0.2); border-radius: var(--radius); padding: 16px 20px; margin-bottom: 24px; text-align: center; }
        .beta-banner p { font-size: 14px; color: #166534; font-weight: 500; margin: 0; }
        .submit-btn { width: 100%; padding: 16px; font-family: var(--font); font-size: 16px; font-weight: 700; background: var(--accent); color: #fff; border: none; border-radius: var(--radius); cursor: pointer; transition: all 0.15s; }
        .submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* PRIVACY PROMISE */
        .privacy-promise { margin-top: 28px; border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
        .privacy-promise-header { display: flex; align-items: center; gap: 10px; padding: 16px 20px; background: var(--bg-white); border-bottom: 1px solid var(--border); }
        .privacy-promise-header svg { width: 18px; height: 18px; color: var(--accent); flex-shrink: 0; }
        .privacy-promise-header strong { font-size: 14px; font-weight: 700; }
        .privacy-promise-body { padding: 16px 20px; background: var(--bg); display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        @media (max-width: 480px) { .privacy-promise-body { grid-template-columns: 1fr; } }
        .pp-item { display: flex; align-items: flex-start; gap: 10px; }
        .pp-dot { width: 20px; height: 20px; border-radius: 50%; background: var(--accent-bg); color: var(--accent); display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 1px; }
        .pp-dot svg { width: 11px; height: 11px; }
        .pp-text { font-size: 13px; color: var(--text-sec); line-height: 1.5; }
        .pp-text strong { color: var(--text); font-weight: 600; display: block; margin-bottom: 1px; }
        .privacy-promise-footer { padding: 12px 20px; border-top: 1px solid var(--border); background: var(--bg-white); font-size: 12px; color: var(--text-muted); line-height: 1.5; }
        .privacy-promise-footer a { color: var(--accent); text-decoration: none; }

        .price-tag { text-align: center; font-size: 13px; color: var(--text-muted); margin-top: 16px; }
        .price-tag a { color: var(--accent); }

        /* LOADING OVERLAY */
        .loading-overlay { display: none; position: fixed; inset: 0; background: rgba(250,250,249,0.97); z-index: 200; flex-direction: column; align-items: center; justify-content: center; gap: 24px; }
        .loading-overlay.active { display: flex; }
        .spinner { width: 48px; height: 48px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .loading-text { font-size: 18px; font-weight: 600; text-align: center; }
        .loading-sub { font-size: 14px; color: var(--text-muted); text-align: center; max-width: 360px; line-height: 1.6; }
        .loading-steps { display: flex; flex-direction: column; gap: 8px; margin-top: 8px; }
        .loading-step { display: flex; align-items: center; gap: 10px; font-size: 14px; color: var(--text-muted); transition: color 0.3s; }
        .loading-step.active { color: var(--text); font-weight: 600; }
        .loading-step.done { color: var(--accent); }
        .loading-step .check { width: 20px; height: 20px; border-radius: 50%; border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 11px; flex-shrink: 0; transition: all 0.3s; }
        .loading-step.active .check { border-color: var(--accent); animation: pulse-border 1.2s ease infinite; }
        .loading-step.done .check { border-color: var(--accent); background: var(--accent); color: #fff; }
        @keyframes pulse-border { 0%, 100% { box-shadow: 0 0 0 0 rgba(22,128,60,0.3); } 50% { box-shadow: 0 0 0 4px rgba(22,128,60,0); } }

        /* REPORT */
        .report-container { display: none; }
        .report-container.active { display: block; }
        .report-iframe-wrap { border-radius: var(--radius); overflow: hidden; border: 1px solid var(--border); }
        #reportFrame { width: 100%; border: none; min-height: 600px; display: block; }
        .report-actions { display: flex; justify-content: center; gap: 12px; margin-top: 20px; flex-wrap: wrap; }
        .action-btn { display: inline-flex; align-items: center; gap: 8px; padding: 12px 24px; background: var(--bg-white); border: 2px solid var(--border); border-radius: var(--radius); font-family: var(--font); font-size: 14px; font-weight: 600; color: var(--text); cursor: pointer; transition: all 0.15s; text-decoration: none; }
        .action-btn:hover { border-color: var(--accent); color: var(--accent); }
        .action-btn.primary { background: var(--accent); border-color: var(--accent); color: #fff; }
        .action-btn.primary:hover { background: var(--accent-hover); border-color: var(--accent-hover); color: #fff; }
    </style>
</head>
<body>

<nav>
    <div class="nav-inner">
        <a href="/" class="logo">
            <div class="logo-icon"><svg fill="none" viewBox="0 0 24 24" stroke="white" stroke-width="2.5"><circle cx="11" cy="11" r="7"/><path d="m16 16 4 4" stroke-linecap="round"/></svg></div>
            <span class="logo-text">Listing Lens</span>
        </a>
        <a href="/" class="nav-link">‚Üê Back to home</a>
    </div>
</nav>

<!-- FORM -->
<div class="container" id="formContainer">
    <h1 class="page-title">New Scan</h1>
    <p class="page-sub">Upload your listing screenshots and we'll do the rest.</p>

    <div class="step-section">
        <div class="step-header"><div class="step-badge">1</div><span class="step-label">What are you looking at?</span></div>
        <div class="category-grid">
            <button class="cat-btn" data-cat="vehicle" onclick="selectCat(this)">
                <span class="emoji">üöó</span>
                <span class="label">Vehicles</span>
                <span class="sublabel">Car, bike, boat, truck, caravan &amp; more</span>
            </button>
            <button class="cat-btn" data-cat="property" onclick="selectCat(this)">
                <span class="emoji">üè†</span>
                <span class="label">Property</span>
                <span class="sublabel">House, apartment, land, commercial</span>
            </button>
            <button class="cat-btn" data-cat="electronics" onclick="selectCat(this)">
                <span class="emoji">üì±</span>
                <span class="label">Electronics</span>
                <span class="sublabel">Phone, computer, TV, appliances</span>
            </button>
            <button class="cat-btn" data-cat="other" onclick="selectCat(this)">
                <span class="emoji">üõçÔ∏è</span>
                <span class="label">Everything Else</span>
                <span class="sublabel">Furniture, fashion, collectibles &amp; more</span>
            </button>
        </div>
    </div>

    <div class="step-section">
        <div class="step-header"><div class="step-badge">2</div><span class="step-label">Upload listing screenshots</span></div>
        <div class="upload-zone" id="uploadZone">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4m4-5 5-5 5 5m-5-5v12" stroke-linecap="round" stroke-linejoin="round"/></svg>
            <h3>Drop screenshots here</h3>
            <p>or click to browse ¬∑ PNG, JPG up to 10MB ¬∑ Up to 6 images</p>
            <input type="file" id="fileInput" accept="image/*" multiple>
        </div>
        <div class="file-list" id="fileList"></div>
    </div>

    <!-- STEP 3: PAYMENT -->
    <div class="step-section payment-section" id="paymentSection">
        <div class="step-header"><div class="step-badge">3</div><span class="step-label">Pay &amp; generate your report</span></div>
        <div class="payment-box">

            <!-- PRICE PICKER -->
            <div class="price-picker" id="pricePicker">
                <div class="price-picker-label">Choose what feels right</div>
                <div class="price-options">
                    <label class="price-opt">
                        <input type="radio" name="price" value="200" checked onchange="onPriceChange(this)">
                        <div class="price-opt-inner">
                            <span class="price-opt-amount">$2</span>
                            <span class="price-opt-tag">Covers costs</span>
                        </div>
                    </label>
                    <label class="price-opt">
                        <input type="radio" name="price" value="500" onchange="onPriceChange(this)">
                        <div class="price-opt-inner">
                            <span class="price-opt-amount">$5</span>
                            <span class="price-opt-tag">Good value</span>
                        </div>
                    </label>
                    <label class="price-opt">
                        <input type="radio" name="price" value="1000" onchange="onPriceChange(this)">
                        <div class="price-opt-inner">
                            <div class="price-opt-badge">üôå Generous</div>
                            <span class="price-opt-amount">$10</span>
                            <span class="price-opt-tag">Helps others pay less</span>
                        </div>
                    </label>
                </div>
            </div>

            <div class="payment-loading" id="paymentLoading">
                <div class="payment-loading-spinner"></div>
                <span id="paymentLoadingText">Securing your screenshots...</span>
            </div>
            <div id="payment-element" style="display:none;"></div>
            <button class="pay-btn" id="payBtn" onclick="handlePayment()" disabled style="display:none;">
                Pay $2 &amp; Generate Report
            </button>
            <div class="payment-error" id="paymentError"></div>
            <div class="payment-secure" id="paymentSecure" style="display:none;">
                <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>
                Secure payment via Stripe ¬∑ Your card details never touch our servers
            </div>
        </div>
    </div>

    <!-- BETA MODE -->
    <div id="betaSection" style="display:none;">
        <div class="beta-banner"><p>üß™ Beta mode ‚Äî payment skipped for testing</p></div>
        <button class="submit-btn" id="betaBtn" disabled onclick="handleBetaSubmit()">Generate Report (Beta)</button>
    </div>

    <!-- PRIVACY PROMISE -->
    <div class="privacy-promise">
        <div class="privacy-promise-header">
            <svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
            <strong>Built on a simple promise: we don't want your data.</strong>
        </div>
        <div class="privacy-promise-body">
            <div class="pp-item">
                <div class="pp-dot"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                <div class="pp-text"><strong>No account. Ever.</strong> You don't sign up, log in, or hand over an email address to use Listing Lens.</div>
            </div>
            <div class="pp-item">
                <div class="pp-dot"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                <div class="pp-text"><strong>Screenshots deleted within 15 minutes.</strong> Held temporarily while your report generates, then automatically and permanently purged ‚Äî whether or not a report was completed.</div>
            </div>
            <div class="pp-item">
                <div class="pp-dot"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                <div class="pp-text"><strong>Report stays on your device.</strong> Generated and sent directly to your browser. We keep no copy on our servers.</div>
            </div>
            <div class="pp-item">
                <div class="pp-dot"><svg fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5"><path d="M5 13l4 4L19 7" stroke-linecap="round" stroke-linejoin="round"/></svg></div>
                <div class="pp-text"><strong>Anonymous payment.</strong> Stripe processes your payment. We never see card details and don't link what you paid to what was in your report.</div>
            </div>
        </div>
        <div class="privacy-promise-footer">
            This is an architecture decision, not just a policy. Data we don't keep can't be leaked, subpoenaed, or hacked. <a href="/privacy.html">Full privacy policy ‚Üí</a>
        </div>
    </div>

    <p class="price-tag">üåè Works with any listing, anywhere ¬∑ Pay what feels right ¬∑ <a href="/why.html">Why so affordable?</a></p>
</div>

<!-- LOADING -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text">Analysing your listing...</div>
    <div class="loading-sub">Our AI is reviewing your screenshots, searching public databases, and building your buyer intelligence report. This usually takes 30‚Äì90 seconds.</div>
    <div class="loading-steps">
        <div class="loading-step" id="ls1"><span class="check"></span> Reading screenshots</div>
        <div class="loading-step" id="ls2"><span class="check"></span> Searching public records &amp; databases</div>
        <div class="loading-step" id="ls3"><span class="check"></span> Analysing pricing &amp; market data</div>
        <div class="loading-step" id="ls4"><span class="check"></span> Generating your report</div>
    </div>
</div>

<!-- REPORT -->
<div class="container report-container" id="reportContainer">
    <div class="report-iframe-wrap">
        <iframe id="reportFrame" sandbox="allow-same-origin" scrolling="no"></iframe>
    </div>
    <div class="report-actions">
        <button class="action-btn primary" onclick="downloadReport()">‚Üì Download Report</button>
        <button class="action-btn" onclick="resetForm()">‚Üê New Scan</button>
    </div>
</div>

<script>
// STATE
let selectedCategory   = null;
let uploadedFiles      = [];
let sessionId          = null;
let stripe             = null;
let elements           = null;
let paymentElement     = null;
let clientSecret       = null;
let paymentIntentId    = null;
let betaMode           = false;
let currentReportHtml  = '';
let currentReportId    = '';
let stripeInitialised  = false;
let stripeInitialising = false;
let uploadInProgress   = false;
let loadingStepTimers  = [];
let selectedPrice      = 200; // cents ‚Äî default $2

// BOOT
async function boot() {
    try {
        const res = await fetch('/api/config');
        if (res.ok) {
            const cfg = await res.json();
            betaMode = cfg.betaMode || false;
            window.STRIPE_PK = cfg.stripePk || '';
        }
    } catch (e) { console.warn('Config fetch failed'); }
}
boot();

// PRICE SELECTION
// Called when user picks $2 / $5 / $10.
// If Stripe is already initialised with a different amount, we need to
// reinitialise with the new amount (new payment intent).
function onPriceChange(input) {
    var newPrice = parseInt(input.value, 10);
    if (newPrice === selectedPrice) return;
    selectedPrice = newPrice;

    // Update pay button label
    var labels = { 200: '$2', 500: '$5', 1000: '$10' };
    var payBtn = document.getElementById('payBtn');
    if (payBtn) payBtn.textContent = 'Pay ' + (labels[selectedPrice] || '$2') + ' & Generate Report';

    // If Stripe was already set up with the old price, reset and reinit
    if (stripeInitialised || stripeInitialising) {
        stripe = null; elements = null; paymentElement = null;
        clientSecret = null; paymentIntentId = null;
        stripeInitialised = false; stripeInitialising = false;
        document.getElementById('payment-element').innerHTML = '';
        document.getElementById('payment-element').style.display = 'none';
        document.getElementById('payBtn').style.display = 'none';
        document.getElementById('paymentSecure').style.display = 'none';
        showPaymentLoading('Updating payment...');
        if (sessionId) initStripe();
    }
}

// CATEGORY SELECTION
function selectCat(btn) {
    document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('selected'));
    btn.classList.add('selected');
    selectedCategory = btn.dataset.cat;
    // Changing category after upload invalidates the Redis session
    sessionId = null;
    stripeInitialised = false;
    stripeInitialising = false;
    checkReady();
}

// FILE HANDLING
const uploadZone = document.getElementById('uploadZone');
const fileInput  = document.getElementById('fileInput');
const fileList   = document.getElementById('fileList');

uploadZone.addEventListener('dragover', e => { e.preventDefault(); uploadZone.classList.add('dragover'); });
uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('dragover'));
uploadZone.addEventListener('drop', e => {
    e.preventDefault();
    uploadZone.classList.remove('dragover');
    handleFiles(e.dataTransfer.files);
});
fileInput.addEventListener('change', e => { handleFiles(e.target.files); fileInput.value = ''; });

function handleFiles(newFiles) {
    for (const f of newFiles) {
        if (uploadedFiles.length >= 6) break;
        if (!f.type.startsWith('image/') || f.size > 10485760) continue;
        uploadedFiles.push(f);
    }
    // Adding files invalidates any existing Redis session
    sessionId = null;
    stripeInitialised = false;
    stripeInitialising = false;
    renderFiles();
    checkReady();
}

function renderFiles() {
    fileList.innerHTML = uploadedFiles.map((f, i) => '<div class="file-item">' +
        '<img src="' + URL.createObjectURL(f) + '" class="file-thumb" alt="">' +
        '<div class="file-info"><div class="file-name">' + esc(f.name) + '</div>' +
        '<div class="file-size">' + (f.size / 1024).toFixed(0) + ' KB</div></div>' +
        '<button class="file-remove" onclick="removeFile(' + i + ')" aria-label="Remove">√ó</button>' +
        '</div>').join('');
    uploadZone.style.display = uploadedFiles.length >= 6 ? 'none' : '';
}

function removeFile(i) {
    uploadedFiles.splice(i, 1);
    sessionId = null;
    stripeInitialised = false;
    stripeInitialising = false;
    renderFiles();
    checkReady();
}

// READY CHECK
// When both category + files ready:
//   Step 1: Upload to Redis -> get sessionId (screenshots safe for 15 min)
//   Step 2: Init Stripe payment element
async function checkReady() {
    const ready = selectedCategory && uploadedFiles.length > 0;

    if (betaMode) {
        document.getElementById('betaSection').style.display = ready ? '' : 'none';
        document.getElementById('paymentSection').classList.remove('active');
        document.getElementById('betaBtn').disabled = !ready;
        return;
    }

    if (ready) {
        document.getElementById('paymentSection').classList.add('active');
        if (!sessionId && !uploadInProgress) {
            await uploadToRedis();
        }
        if (sessionId && !stripeInitialised && !stripeInitialising) {
            await initStripe();
        }
    } else {
        document.getElementById('paymentSection').classList.remove('active');
    }
}

// STEP 1: Upload screenshots to Upstash Redis
// Returns sessionId ‚Äî screenshots auto-deleted in 15 minutes by TTL
async function uploadToRedis() {
    uploadInProgress = true;
    showPaymentLoading('Securing your screenshots...');

    try {
        const fd = new FormData();
        fd.append('category', selectedCategory);
        uploadedFiles.forEach((f, i) => fd.append('screenshot_' + i, f));

        const res  = await fetch('/api/upload-screenshots', { method: 'POST', body: fd });
        const data = await res.json();

        if (!res.ok) throw new Error(data.error || 'Upload failed');

        sessionId = data.sessionId;
        showPaymentLoading('Setting up secure payment...');

    } catch (err) {
        console.error('Redis upload error:', err);
        hidePaymentLoading();
        showPaymentError('Could not secure your screenshots. Please try again.');
    } finally {
        uploadInProgress = false;
    }
}

// STEP 2: Init Stripe payment element
async function initStripe() {
    stripeInitialising = true;

    try {
        const res  = await fetch('/api/create-payment', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount: selectedPrice })
        });
        const data = await res.json();

        if (!data.clientSecret) throw new Error('No client secret');

        clientSecret    = data.clientSecret;
        paymentIntentId = data.paymentIntentId;

        if (!window.STRIPE_PK) throw new Error('Stripe key not configured');

        stripe   = Stripe(window.STRIPE_PK);
        elements = stripe.elements({
            clientSecret,
            appearance: {
                theme: 'stripe',
                variables: {
                    colorPrimary: '#16803C', colorBackground: '#FFFFFF',
                    colorText: '#1A1A1A', colorDanger: '#DC2626',
                    fontFamily: 'DM Sans, system-ui, sans-serif',
                    spacingUnit: '4px', borderRadius: '8px'
                }
            }
        });

        paymentElement = elements.create('payment');
        paymentElement.mount('#payment-element');

        paymentElement.on('ready', function() {
            hidePaymentLoading();
            document.getElementById('payment-element').style.display = '';
            document.getElementById('payBtn').style.display = '';
            document.getElementById('paymentSecure').style.display = '';
            var labels = { 200: '$2', 500: '$5', 1000: '$10' };
            document.getElementById('payBtn').textContent = 'Pay ' + (labels[selectedPrice] || '$2') + ' & Generate Report';
            stripeInitialised  = true;
            stripeInitialising = false;
        });

        paymentElement.on('change', function(event) {
            document.getElementById('payBtn').disabled = !event.complete;
            if (event.error) showPaymentError(event.error.message);
            else hidePaymentError();
        });

    } catch (err) {
        console.error('Stripe init error:', err);
        hidePaymentLoading();
        showPaymentError('Payment system unavailable. Please refresh and try again.');
        stripeInitialising = false;
    }
}

// UI helpers
function showPaymentLoading(msg) {
    document.getElementById('paymentLoadingText').textContent = msg || 'Loading...';
    document.getElementById('paymentLoading').style.display = 'flex';
    document.getElementById('payment-element').style.display = 'none';
    document.getElementById('payBtn').style.display = 'none';
    document.getElementById('paymentSecure').style.display = 'none';
}
function hidePaymentLoading() {
    document.getElementById('paymentLoading').style.display = 'none';
}
function showPaymentError(msg) {
    const el = document.getElementById('paymentError');
    el.textContent = msg;
    el.style.display = '';
}
function hidePaymentError() {
    document.getElementById('paymentError').style.display = 'none';
}

// PAYMENT HANDLER
async function handlePayment() {
    const payBtn = document.getElementById('payBtn');
    payBtn.disabled    = true;
    payBtn.textContent = 'Processing...';

    const { error } = await stripe.confirmPayment({
        elements,
        confirmParams: { return_url: window.location.href },
        redirect: 'if_required'
    });

    if (error) {
        showPaymentError(error.message);
        payBtn.disabled    = false;
        payBtn.textContent = 'Pay $2 & Generate Report';
        return;
    }

    generateReport(paymentIntentId);
}

function handleBetaSubmit() { generateReport(null); }

// LOADING STEPS
function startLoadingSteps() {
    ['ls1','ls2','ls3','ls4'].forEach(function(id) {
        var el = document.getElementById(id);
        el.classList.remove('active','done');
        el.querySelector('.check').textContent = '';
    });
    setStepActive('ls1');
    loadingStepTimers = [
        setTimeout(function() { advanceStep('ls1','ls2'); }, 4000),
        setTimeout(function() { advanceStep('ls2','ls3'); }, 10000)
    ];
}

function setStepActive(id) { document.getElementById(id).classList.add('active'); }

function advanceStep(fromId, toId) {
    var from = document.getElementById(fromId);
    from.classList.remove('active');
    from.classList.add('done');
    from.querySelector('.check').textContent = '‚úì';
    if (toId) setStepActive(toId);
}

function completeAllSteps() {
    loadingStepTimers.forEach(function(t) { clearTimeout(t); });
    loadingStepTimers = [];
    ['ls1','ls2','ls3'].forEach(function(id) {
        var el = document.getElementById(id);
        el.classList.remove('active');
        el.classList.add('done');
        el.querySelector('.check').textContent = '‚úì';
    });
    advanceStep('ls3','ls4');
    return new Promise(function(resolve) {
        setTimeout(function() { advanceStep('ls4', null); resolve(); }, 600);
    });
}

// GENERATE REPORT
// Passes sessionId (Redis key) ‚Äî not raw files ‚Äî to generate-report function
async function generateReport(paymentId) {
    document.getElementById('formContainer').style.display = 'none';
    document.getElementById('loadingOverlay').classList.add('active');
    startLoadingSteps();

    try {
        var sid = sessionId;

        // Beta / fallback: upload on the fly if no sessionId yet
        if (!sid) {
            var fd = new FormData();
            fd.append('category', selectedCategory);
            uploadedFiles.forEach(function(f, i) { fd.append('screenshot_' + i, f); });
            var upRes  = await fetch('/api/upload-screenshots', { method: 'POST', body: fd });
            var upData = await upRes.json();
            if (!upRes.ok) throw new Error(upData.error || 'Upload failed');
            sid = upData.sessionId;
        }

        var res = await fetch('/api/generate-report', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ sessionId: sid, paymentIntentId: paymentId })
        });

        if (!res.ok) {
            var errData = await res.json().catch(function() { return {}; });
            if (res.status === 410) {
                throw new Error('EXPIRED:' + (errData.message || 'Session expired ‚Äî please re-upload your screenshots.'));
            }
            throw new Error(errData.error || 'HTTP ' + res.status);
        }

        var report = await res.json();
        await completeAllSteps();
        await new Promise(function(r) { setTimeout(r, 300); });
        document.getElementById('loadingOverlay').classList.remove('active');
        renderReport(report);

    } catch (err) {
        loadingStepTimers.forEach(function(t) { clearTimeout(t); });
        document.getElementById('loadingOverlay').classList.remove('active');
        document.getElementById('formContainer').style.display = '';

        var msg = err.message || 'Unknown error';
        if (msg.startsWith('EXPIRED:')) {
            alert('‚è± ' + msg.replace('EXPIRED:', '') + '\n\nThis happens if more than 15 minutes passed between uploading and paying. Please re-upload ‚Äî your payment intent is still valid.');
        } else {
            alert('Something went wrong.\n\nIf payment was taken, contact hello@listinglens.app for a refund.\n\nError: ' + msg);
        }
        console.error(err);
    }
}

// REPORT RENDERER
function renderReport(r) {
    var container = document.getElementById('reportContainer');
    var frame     = document.getElementById('reportFrame');

    if (r.format === 'html' && r.html) {
        currentReportHtml = r.html;
        currentReportId   = r.reportId || 'LL-REPORT';
        frame.srcdoc      = r.html;
        frame.onload = function() {
            try {
                var doc = frame.contentDocument;
                doc.documentElement.style.overflow = 'hidden';
                doc.body.style.overflow = 'hidden';
                var h = Math.max(doc.body.scrollHeight, doc.documentElement.scrollHeight);
                frame.style.height = (h + 32) + 'px';
            } catch (e) { frame.style.height = '4000px'; }
        };
    } else {
        currentReportHtml = '<html><body><pre style="padding:24px;font-family:monospace;font-size:13px;">' + esc(JSON.stringify(r, null, 2)) + '</pre></body></html>';
        currentReportId   = 'LL-REPORT';
        frame.srcdoc      = currentReportHtml;
        frame.style.height = '600px';
    }

    container.classList.add('active');
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// DOWNLOAD
function downloadReport() {
    if (!currentReportHtml) return;
    var blob = new Blob([currentReportHtml], { type: 'text/html' });
    var url  = URL.createObjectURL(blob);
    var a    = document.createElement('a');
    a.href   = url;
    a.download = currentReportId + '.html';
    a.click();
    URL.revokeObjectURL(url);
}

// RESET
function resetForm() {
    selectedCategory = null; uploadedFiles = []; sessionId = null; selectedPrice = 200;
    stripe = null; elements = null; paymentElement = null;
    clientSecret = null; paymentIntentId = null;
    stripeInitialised = false; stripeInitialising = false; uploadInProgress = false;
    currentReportHtml = ''; currentReportId = '';

    document.querySelectorAll('.cat-btn').forEach(function(b) { b.classList.remove('selected'); });
    fileList.innerHTML = '';
    uploadZone.style.display = '';
    document.getElementById('paymentSection').classList.remove('active');
    document.getElementById('betaSection').style.display = 'none';
    document.getElementById('payment-element').innerHTML = '';
    document.getElementById('payment-element').style.display = 'none';
    document.getElementById('payBtn').style.display = 'none';
    document.getElementById('paymentSecure').style.display = 'none';
    showPaymentLoading('Securing your screenshots...');
    hidePaymentError();
    document.getElementById('reportContainer').classList.remove('active');
    document.getElementById('reportFrame').srcdoc = '';
    document.getElementById('reportFrame').style.height = '';
    document.getElementById('formContainer').style.display = '';

    ['ls1','ls2','ls3','ls4'].forEach(function(id) {
        var el = document.getElementById(id);
        el.classList.remove('active','done');
        el.querySelector('.check').textContent = '';
    });
    loadingStepTimers.forEach(function(t) { clearTimeout(t); });
    loadingStepTimers = [];
    // Reset price picker to $2
    var radios = document.querySelectorAll('input[name="price"]');
    radios.forEach(function(r) { r.checked = r.value === '200'; });
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// UTILS
function esc(str) {
    if (!str) return '';
    return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>
</body>
</html>
